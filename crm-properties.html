<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gayrimenkul Yönetimi - Arsarazi CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#0B5394',
                        'primary-green': '#52B947',
                        'primary-yellow': '#FFC000',
                        'blue-dark': '#0A4A7A',
                        'green-dark': '#45A038',
                        'yellow-dark': '#E6A800'
                    }
                }
            }
        }
    </script>
    <style>
        .sidebar { 
            position: fixed; 
            height: 100vh; 
            overflow-y: auto; 
        }
        .main-content { 
            margin-left: 16rem; 
        }
        .sidebar-item {
            transition: all 0.3s ease;
        }
        .sidebar-item:hover {
            background-color: #f3f4f6;
        }
        .sidebar-item.active {
            background-color: #52B947;
            color: white;
        }
        .sidebar-item.active i {
            color: white;
        }
        @media (max-width: 768px) {
            .sidebar { position: relative; height: auto; }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex">
        <!-- Sidebar -->
        <aside class="sidebar w-64 bg-white shadow-lg flex flex-col">
            <div class="p-4 border-b">
                <div class="flex items-center logo-container">
                    <img src="https://page.gensparksite.com/v1/base64_upload/db906ae7116ab45188a186d28c235383" 
                         alt="Arsarazi Logo" 
                         class="h-10 w-auto mr-2">
                    <span class="text-xl font-bold text-primary-blue">ARSARAZI CRM</span>
                </div>
            </div>
            
            <nav class="p-4 flex-1">
                <a href="dashboard.html" class="sidebar-item flex items-center p-3 rounded-lg mb-2">
                    <i class="fas fa-chart-line w-6 text-gray-600"></i>
                    <span class="ml-3">Dashboard</span>
                </a>
                <a href="crm-properties.html" class="sidebar-item active flex items-center p-3 rounded-lg mb-2">
                    <i class="fas fa-building w-6 text-primary-green"></i>
                    <span class="ml-3">Gayrimenkuller</span>
                </a>
                <a href="crm-customers.html" class="sidebar-item flex items-center p-3 rounded-lg mb-2">
                    <i class="fas fa-users w-6 text-gray-600"></i>
                    <span class="ml-3">Müşteriler</span>
                </a>
                <a href="crm-transactions.html" class="sidebar-item flex items-center p-3 rounded-lg mb-2">
                    <i class="fas fa-exchange-alt w-6 text-gray-600"></i>
                    <span class="ml-3">İşlemler</span>
                </a>
                <a href="crm-documents.html" class="sidebar-item flex items-center p-3 rounded-lg mb-2">
                    <i class="fas fa-file-alt w-6 text-gray-600"></i>
                    <span class="ml-3">Dokümanlar</span>
                </a>
                <a href="crm-reports.html" class="sidebar-item flex items-center p-3 rounded-lg mb-2">
                    <i class="fas fa-chart-bar w-6 text-gray-600"></i>
                    <span class="ml-3">Raporlar</span>
                </a>
                <a href="crm-calendar.html" class="sidebar-item flex items-center p-3 rounded-lg mb-2">
                    <i class="fas fa-calendar w-6 text-gray-600"></i>
                    <span class="ml-3">Takvim</span>
                </a>
                <a href="crm-settings.html" class="sidebar-item flex items-center p-3 rounded-lg mb-2">
                    <i class="fas fa-cog w-6 text-gray-600"></i>
                    <span class="ml-3">Ayarlar</span>
                </a>
                
                <div class="border-t pt-4 mt-4">
                    <a href="index.html" class="sidebar-item flex items-center p-3 rounded-lg mb-2">
                        <i class="fas fa-globe w-6 text-gray-600"></i>
                        <span class="ml-3">Web Sitesine Git</span>
                    </a>
                    <button onclick="logout()" class="sidebar-item w-full flex items-center p-3 rounded-lg text-red-600 hover:bg-red-50">
                        <i class="fas fa-sign-out-alt w-6"></i>
                        <span class="ml-3">Çıkış Yap</span>
                    </button>
                </div>
            </nav>
            
            <div class="p-4 border-t mt-auto">
                <div class="flex items-center">
                    <img src="https://ui-avatars.com/api/?name=Admin+User&background=52B947&color=fff" 
                         class="w-10 h-10 rounded-full">
                    <div class="ml-3">
                        <p class="text-sm font-medium">Admin User</p>
                        <p class="text-xs text-gray-500">admin@arsarazi.com</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content flex-1">
            <!-- Top Bar -->
            <header class="bg-white shadow-sm border-b">
                <div class="flex items-center justify-between px-6 py-4">
                    <h1 class="text-2xl font-bold text-gray-800">Gayrimenkul Yönetimi</h1>
                    <div class="flex items-center space-x-4">
                        <button onclick="showAddPropertyModal()" class="bg-primary-green text-white px-4 py-2 rounded-lg hover:bg-green-dark transition flex items-center">
                            <i class="fas fa-plus mr-2"></i>
                            Yeni Gayrimenkul
                        </button>
                        <button class="relative p-2 text-gray-600 hover:text-primary-green">
                            <i class="fas fa-bell text-xl"></i>
                            <span class="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">3</span>
                        </button>
                        <a href="index.html" class="p-2 text-gray-600 hover:text-primary-green">
                            <i class="fas fa-home text-xl"></i>
                        </a>
                    </div>
                </div>
            </header>

            <!-- Dashboard Content -->
            <div class="p-6">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="stat-card bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-gray-500 text-sm font-medium">Toplam Gayrimenkul</p>
                                <p class="text-3xl font-bold text-gray-800 mt-1" id="totalProperties">0</p>
                            </div>
                            <div class="bg-primary-green/10 p-4 rounded-full flex-shrink-0">
                                <i class="fas fa-building text-2xl text-primary-green"></i>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-gray-500 text-sm font-medium">Yayında</p>
                                <p class="text-3xl font-bold text-gray-800 mt-1" id="publishedProperties">0</p>
                            </div>
                            <div class="bg-primary-blue/10 p-4 rounded-full flex-shrink-0">
                                <i class="fas fa-globe text-2xl text-primary-blue"></i>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-gray-500 text-sm font-medium">Toplam Değer</p>
                                <p class="text-3xl font-bold text-gray-800 mt-1" id="totalValue">₺0</p>
                            </div>
                            <div class="bg-primary-yellow/10 p-4 rounded-full flex-shrink-0">
                                <i class="fas fa-lira-sign text-2xl text-yellow-600"></i>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-gray-500 text-sm font-medium">Bu Ay Eklenen</p>
                                <p class="text-3xl font-bold text-gray-800 mt-1" id="monthlyAdded">0</p>
                            </div>
                            <div class="bg-green-100 p-4 rounded-full flex-shrink-0">
                                <i class="fas fa-plus text-2xl text-green-600"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters and Search -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                        <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-6">
                            <div class="flex items-center space-x-2">
                                <select id="statusFilter" class="border rounded-lg px-4 py-2 text-sm">
                                    <option value="">Tüm Durumlar</option>
                                    <option value="Satılık">Satılık</option>
                                    <option value="Kiralık">Kiralık</option>
                                    <option value="Satıldı">Satıldı</option>
                                    <option value="Kiralandı">Kiralandı</option>
                                </select>
                                <select id="typeFilter" class="border rounded-lg px-4 py-2 text-sm">
                                    <option value="">Tüm Tipler</option>
                                    <option value="Arsa">Arsa</option>
                                    <option value="Villa">Villa</option>
                                    <option value="Daire">Daire</option>
                                    <option value="Tarla">Tarla</option>
                                    <option value="Dükkan">Dükkan</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="text" id="searchInput" placeholder="Gayrimenkul ara..." class="border rounded-lg px-4 py-2 text-sm">
                                <button onclick="searchProperties()" class="bg-primary-blue text-white px-4 py-2 rounded-lg hover:bg-blue-dark transition">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Properties List View -->
                <div class="bg-white rounded-lg shadow">
                    <!-- List Header -->
                    <div class="p-4 border-b bg-gray-50">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="selectAll" class="rounded border-gray-300 text-primary-green focus:ring-primary-green" onchange="toggleSelectAll()">
                                    <span class="ml-2 text-sm font-medium text-gray-700">Tümünü Seç</span>
                                </label>
                                <span id="selectedCount" class="text-sm text-gray-500">0 seçili</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button id="publishBtn" onclick="publishSelected()" class="px-4 py-2 bg-primary-green text-white rounded-lg hover:bg-green-dark text-sm hidden">
                                    <i class="fas fa-globe mr-1"></i>Yayınla
                                </button>
                                <button id="unpublishBtn" onclick="unpublishSelected()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-sm hidden">
                                    <i class="fas fa-eye-slash mr-1"></i>Yayından Kaldır
                                </button>
                                <button onclick="deleteSelected()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm hidden" id="deleteBtn">
                                    <i class="fas fa-trash mr-1"></i>Sil
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Properties Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-8">
                                        <input type="checkbox" id="headerCheckbox" class="rounded border-gray-300 text-primary-green focus:ring-primary-green" onchange="toggleSelectAll()">
                                    </th>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">
                                        Gayrimenkul
                                    </th>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">
                                        Tip
                                    </th>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">
                                        Alan
                                    </th>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">
                                        Fiyat
                                    </th>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">
                                        Durum
                                    </th>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">
                                        Yayın Durumu
                                    </th>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">
                                        İşlemler
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="propertiesTableBody">
                                <!-- Property rows will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Property Modal -->
    <div id="addPropertyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold">Yeni Gayrimenkul Ekle</h3>
                <button onclick="closeAddPropertyModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="addPropertyForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Başlık</label>
                        <input type="text" id="propertyTitle" required class="w-full border rounded-lg px-4 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tür</label>
                        <select id="propertyType" required class="w-full border rounded-lg px-4 py-2">
                            <option value="">Seçin</option>
                            <option value="Arsa">Arsa</option>
                            <option value="Villa">Villa</option>
                            <option value="Daire">Daire</option>
                            <option value="Tarla">Tarla</option>
                            <option value="Dükkan">Dükkan</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Alan (m²)</label>
                        <input type="number" id="propertyArea" required class="w-full border rounded-lg px-4 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fiyat (₺)</label>
                        <input type="number" id="propertyPrice" required class="w-full border rounded-lg px-4 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Durum</label>
                        <select id="propertyStatus" required class="w-full border rounded-lg px-4 py-2">
                            <option value="">Seçin</option>
                            <option value="Satılık">Satılık</option>
                            <option value="Kiralık">Kiralık</option>
                            <option value="Satıldı">Satıldı</option>
                            <option value="Kiralandı">Kiralandı</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Lokasyon</label>
                        <input type="text" id="propertyLocation" required class="w-full border rounded-lg px-4 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">İmar Durumu</label>
                        <input type="text" id="propertyZoning" class="w-full border rounded-lg px-4 py-2">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Açıklama</label>
                    <textarea id="propertyDescription" rows="3" class="w-full border rounded-lg px-4 py-2"></textarea>
                </div>
                
                <div class="flex justify-end space-x-3 pt-6">
                    <button type="button" onclick="closeAddPropertyModal()" class="px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-50">
                        İptal
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary-green text-white rounded-lg hover:bg-green-dark">
                        Gayrimenkul Ekle
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let properties = [];
        let selectedProperties = new Set();

        // Initialize properties page
        document.addEventListener('DOMContentLoaded', function() {
            if (localStorage.getItem('adminLoggedIn') !== 'true') {
                window.location.href = 'admin.html';
            }
            
            // Set active menu item
            setActiveMenuItem();
            
            // Load properties
            loadProperties();
        });

        // Set active menu item based on current page
        function setActiveMenuItem() {
            const currentPage = window.location.pathname.split('/').pop() || 'dashboard.html';
            const menuItems = document.querySelectorAll('.sidebar-item');
            
            menuItems.forEach(item => {
                item.classList.remove('active');
                const icon = item.querySelector('i');
                icon.classList.remove('text-primary-green');
                icon.classList.add('text-gray-600');
            });
            
            // Find and activate current page menu item
            menuItems.forEach(item => {
                if (item.getAttribute('href') === currentPage) {
                    item.classList.add('active');
                    const icon = item.querySelector('i');
                    icon.classList.remove('text-gray-600');
                    icon.classList.add('text-primary-green');
                }
            });
        }

        // Load properties from backend
        async function loadProperties() {
            try {
                const response = await fetch('/api/gayrimenkuller');
                const data = await response.json();
                
                if (data.durum === 'Başarılı') {
                    properties = data.veri.map(property => ({
                        ...property,
                        published: property.published || false
                    }));
                    renderProperties();
                    updateStats();
                }
            } catch (error) {
                console.error('Gayrimenkul yükleme hatası:', error);
                // Fallback to sample data
                properties = [
                    {
                        id: 1,
                        title: 'Karesi Merkez Arsa',
                        type: 'Arsa',
                        area: 500,
                        price: 1250000,
                        status: 'Satılık',
                        location: 'Karesi, Balıkesir',
                        zoning: 'Konut',
                        description: 'Merkezi konumda, yatırıma uygun arsa',
                        published: false
                    },
                    {
                        id: 2,
                        title: 'Bandırma Villa',
                        type: 'Villa',
                        area: 250,
                        price: 3500000,
                        status: 'Satılık',
                        location: 'Bandırma, Balıkesir',
                        zoning: 'Konut',
                        description: 'Deniz manzaralı lüks villa',
                        published: true
                    },
                    {
                        id: 3,
                        title: 'Altıeylül Tarla',
                        type: 'Tarla',
                        area: 1000,
                        price: 500000,
                        status: 'Satılık',
                        location: 'Altıeylül, Balıkesir',
                        zoning: 'Tarım',
                        description: 'Verimli tarım arazisi',
                        published: false
                    }
                ];
                renderProperties();
                updateStats();
            }
        }

        // Update statistics
        function updateStats() {
            const totalProperties = properties.length;
            const publishedProperties = properties.filter(p => p.published).length;
            const totalValue = properties.reduce((sum, p) => sum + (p.fiyat || p.price || 0), 0);
            const monthlyAdded = properties.filter(p => {
                const addedDate = new Date(p.tarih || Date.now());
                const now = new Date();
                return addedDate.getMonth() === now.getMonth() && addedDate.getFullYear() === now.getFullYear();
            }).length;

            document.getElementById('totalProperties').textContent = totalProperties;
            document.getElementById('publishedProperties').textContent = publishedProperties;
            document.getElementById('totalValue').textContent = `₺${totalValue.toLocaleString()}`;
            document.getElementById('monthlyAdded').textContent = monthlyAdded;
        }

        // Render properties in table
        function renderProperties() {
            const tbody = document.getElementById('propertiesTableBody');
            tbody.innerHTML = '';
            
            properties.forEach(property => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-2 py-3 whitespace-nowrap">
                        <input type="checkbox" class="property-checkbox rounded border-gray-300 text-primary-green focus:ring-primary-green" value="${property.id}" onchange="updateSelection()">
                    </td>
                    <td class="px-2 py-3">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-8 w-8">
                                <div class="h-8 w-8 rounded-full bg-primary-green/10 flex items-center justify-center">
                                    <i class="fas fa-building text-primary-green text-sm"></i>
                                </div>
                            </div>
                            <div class="ml-3">
                                <div class="text-sm font-medium text-gray-900 truncate max-w-xs">${property.aciklama || property.title || 'Gayrimenkul'}</div>
                                <div class="text-xs text-gray-500 truncate max-w-xs">${property.konum || property.location || 'Konum belirtilmemiş'}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-2 py-3 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                            ${property.tip || property.type || 'Belirtilmemiş'}
                        </span>
                    </td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">
                        ${(property.alan || property.area || 0).toLocaleString()} m²
                    </td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">
                        ₺${(property.fiyat || property.price || 0).toLocaleString()}
                    </td>
                    <td class="px-2 py-3 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(property.durum || property.status)}">
                            ${property.durum || property.status || 'Belirtilmemiş'}
                        </span>
                    </td>
                    <td class="px-2 py-3 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${property.published ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${property.published ? 'Yayında' : 'Yayında Değil'}
                        </span>
                    </td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm font-medium">
                        <div class="flex items-center space-x-1">
                            <button onclick="viewProperty('${property.id}')" class="text-primary-blue hover:text-blue-dark p-1">
                                <i class="fas fa-eye text-sm"></i>
                            </button>
                            <button onclick="editProperty('${property.id}')" class="text-primary-green hover:text-green-dark p-1">
                                <i class="fas fa-edit text-sm"></i>
                            </button>
                            <button onclick="deleteProperty('${property.id}')" class="text-red-600 hover:text-red-800 p-1">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Get status color
        function getStatusColor(status) {
            switch(status) {
                case 'Satılık':
                    return 'bg-green-100 text-green-800';
                case 'Kiralık':
                    return 'bg-blue-100 text-blue-800';
                case 'Satıldı':
                    return 'bg-red-100 text-red-800';
                case 'Kiralandı':
                    return 'bg-purple-100 text-purple-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        // Update selection count and buttons
        function updateSelection() {
            const checkboxes = document.querySelectorAll('.property-checkbox:checked');
            const selectedCount = checkboxes.length;
            
            document.getElementById('selectedCount').textContent = `${selectedCount} seçili`;
            
            // Show/hide action buttons
            const publishBtn = document.getElementById('publishBtn');
            const unpublishBtn = document.getElementById('unpublishBtn');
            const deleteBtn = document.getElementById('deleteBtn');
            
            if (selectedCount > 0) {
                publishBtn.classList.remove('hidden');
                unpublishBtn.classList.remove('hidden');
                deleteBtn.classList.remove('hidden');
            } else {
                publishBtn.classList.add('hidden');
                unpublishBtn.classList.add('hidden');
                deleteBtn.classList.add('hidden');
            }
        }

        // Toggle select all
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const headerCheckbox = document.getElementById('headerCheckbox');
            const propertyCheckboxes = document.querySelectorAll('.property-checkbox');
            
            const isChecked = selectAllCheckbox.checked || headerCheckbox.checked;
            
            propertyCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            
            updateSelection();
        }

        // Publish selected properties
        async function publishSelected() {
            const selectedIds = getSelectedIds();
            if (selectedIds.length === 0) return;
            
            if (confirm(`${selectedIds.length} gayrimenkulü yayınlamak istediğinizden emin misiniz?`)) {
                try {
                    // Update properties locally
                    properties.forEach(property => {
                        if (selectedIds.includes(property.id)) {
                            property.published = true;
                        }
                    });
                    
                    // Update backend
                    await updatePropertiesBackend();
                    
                    renderProperties();
                    updateSelection();
                    updateStats();
                    
                    alert('Seçili gayrimenkuller yayınlandı!');
                } catch (error) {
                    console.error('Yayınlama hatası:', error);
                    alert('Yayınlama sırasında hata oluştu!');
                }
            }
        }

        // Unpublish selected properties
        async function unpublishSelected() {
            const selectedIds = getSelectedIds();
            if (selectedIds.length === 0) return;
            
            if (confirm(`${selectedIds.length} gayrimenkulü yayından kaldırmak istediğinizden emin misiniz?`)) {
                try {
                    // Update properties locally
                    properties.forEach(property => {
                        if (selectedIds.includes(property.id)) {
                            property.published = false;
                        }
                    });
                    
                    // Update backend
                    await updatePropertiesBackend();
                    
                    renderProperties();
                    updateSelection();
                    updateStats();
                    
                    alert('Seçili gayrimenkuller yayından kaldırıldı!');
                } catch (error) {
                    console.error('Yayından kaldırma hatası:', error);
                    alert('Yayından kaldırma sırasında hata oluştu!');
                }
            }
        }

        // Delete selected properties
        async function deleteSelected() {
            const selectedIds = getSelectedIds();
            if (selectedIds.length === 0) return;
            
            if (confirm(`${selectedIds.length} gayrimenkulü silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!`)) {
                try {
                    // Remove from local array
                    properties = properties.filter(property => !selectedIds.includes(property.id));
                    
                    // Update backend
                    await updatePropertiesBackend();
                    
                    renderProperties();
                    updateSelection();
                    updateStats();
                    
                    alert('Seçili gayrimenkuller silindi!');
                } catch (error) {
                    console.error('Silme hatası:', error);
                    alert('Silme sırasında hata oluştu!');
                }
            }
        }

        // Get selected property IDs
        function getSelectedIds() {
            const checkboxes = document.querySelectorAll('.property-checkbox:checked');
            return Array.from(checkboxes).map(checkbox => checkbox.value);
        }

        // Update properties in backend
        async function updatePropertiesBackend() {
            try {
                // Backend güncelleme yerine sadece local storage'a kaydet
                localStorage.setItem('properties', JSON.stringify(properties));
                console.log('Gayrimenkuller güncellendi');
            } catch (error) {
                console.error('Güncelleme hatası:', error);
                throw error;
            }
        }

        // Property actions
        function viewProperty(id) {
            const property = properties.find(p => p.id == id);
            if (property) {
                alert(`Gayrimenkul Detayları:\n\nBaşlık: ${property.aciklama || property.title}\nTip: ${property.tip || property.type}\nAlan: ${(property.alan || property.area || 0).toLocaleString()} m²\nFiyat: ₺${(property.fiyat || property.price || 0).toLocaleString()}\nDurum: ${property.durum || property.status}\nKonum: ${property.konum || property.location}`);
            } else {
                alert('Gayrimenkul bulunamadı!');
            }
        }

        function editProperty(id) {
            const property = properties.find(p => p.id == id);
            if (property) {
                // Form alanlarını doldur
                document.getElementById('propertyTitle').value = property.aciklama || property.title || '';
                document.getElementById('propertyType').value = property.tip || property.type || '';
                document.getElementById('propertyArea').value = property.alan || property.area || '';
                document.getElementById('propertyPrice').value = property.fiyat || property.price || '';
                document.getElementById('propertyStatus').value = property.durum || property.status || '';
                document.getElementById('propertyLocation').value = property.konum || property.location || '';
                document.getElementById('propertyZoning').value = property.imar_durumu || property.zoning || '';
                document.getElementById('propertyDescription').value = property.aciklama || property.description || '';
                
                // Modal'ı aç
                showAddPropertyModal();
                
                // Form submit butonunu güncelle
                const submitBtn = document.querySelector('#addPropertyForm button[type="submit"]');
                submitBtn.textContent = 'Gayrimenkul Güncelle';
                submitBtn.onclick = function(e) {
                    e.preventDefault();
                    updateProperty(id);
                };
            } else {
                alert('Gayrimenkul bulunamadı!');
            }
        }

        function updateProperty(id) {
            const propertyIndex = properties.findIndex(p => p.id == id);
            if (propertyIndex !== -1) {
                properties[propertyIndex] = {
                    ...properties[propertyIndex],
                    aciklama: document.getElementById('propertyTitle').value,
                    tip: document.getElementById('propertyType').value,
                    alan: parseInt(document.getElementById('propertyArea').value),
                    fiyat: parseInt(document.getElementById('propertyPrice').value),
                    durum: document.getElementById('propertyStatus').value,
                    konum: document.getElementById('propertyLocation').value,
                    imar_durumu: document.getElementById('propertyZoning').value,
                    guncelleme_tarihi: new Date().toISOString()
                };
                
                renderProperties();
                updateStats();
                closeAddPropertyModal();
                
                // Form submit butonunu eski haline getir
                const submitBtn = document.querySelector('#addPropertyForm button[type="submit"]');
                submitBtn.textContent = 'Gayrimenkul Ekle';
                submitBtn.onclick = null;
                
                alert('Gayrimenkul başarıyla güncellendi!');
            }
        }

        function deleteProperty(id) {
            if (confirm('Bu gayrimenkulü silmek istediğinizden emin misiniz?')) {
                properties = properties.filter(p => p.id != id);
                renderProperties();
                updateStats();
                alert('Gayrimenkul başarıyla silindi!');
            }
        }

        // Modal functions
        function showAddPropertyModal() {
            document.getElementById('addPropertyModal').classList.remove('hidden');
        }

        function closeAddPropertyModal() {
            document.getElementById('addPropertyModal').classList.add('hidden');
            document.getElementById('addPropertyForm').reset();
            
            // Form submit butonunu eski haline getir
            const submitBtn = document.querySelector('#addPropertyForm button[type="submit"]');
            submitBtn.textContent = 'Gayrimenkul Ekle';
            submitBtn.onclick = null;
        }

        // Form submission
        document.getElementById('addPropertyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newProperty = {
                id: Date.now(),
                title: document.getElementById('propertyTitle').value,
                type: document.getElementById('propertyType').value,
                area: parseInt(document.getElementById('propertyArea').value),
                price: parseInt(document.getElementById('propertyPrice').value),
                status: document.getElementById('propertyStatus').value,
                location: document.getElementById('propertyLocation').value,
                zoning: document.getElementById('propertyZoning').value,
                description: document.getElementById('propertyDescription').value,
                published: false,
                tarih: new Date().toISOString()
            };
            
            properties.push(newProperty);
            renderProperties();
            updateStats();
            closeAddPropertyModal();
            
            alert('Gayrimenkul başarıyla eklendi!');
        });

        // Search and filter functions
        function searchProperties() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            
            const filteredProperties = properties.filter(property => {
                const matchesSearch = (property.aciklama || property.title || '').toLowerCase().includes(searchTerm) ||
                                    (property.konum || property.location || '').toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || (property.durum || property.status) === statusFilter;
                const matchesType = !typeFilter || (property.tip || property.type) === typeFilter;
                
                return matchesSearch && matchesStatus && matchesType;
            });
            
            renderFilteredProperties(filteredProperties);
        }

        function renderFilteredProperties(filteredProperties) {
            const tbody = document.getElementById('propertiesTableBody');
            tbody.innerHTML = '';
            
            filteredProperties.forEach(property => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-2 py-3 whitespace-nowrap">
                        <input type="checkbox" class="property-checkbox rounded border-gray-300 text-primary-green focus:ring-primary-green" value="${property.id}" onchange="updateSelection()">
                    </td>
                    <td class="px-2 py-3">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-8 w-8">
                                <div class="h-8 w-8 rounded-full bg-primary-green/10 flex items-center justify-center">
                                    <i class="fas fa-building text-primary-green text-sm"></i>
                                </div>
                            </div>
                            <div class="ml-3">
                                <div class="text-sm font-medium text-gray-900 truncate max-w-xs">${property.aciklama || property.title || 'Gayrimenkul'}</div>
                                <div class="text-xs text-gray-500 truncate max-w-xs">${property.konum || property.location || 'Konum belirtilmemiş'}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-2 py-3 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                            ${property.tip || property.type || 'Belirtilmemiş'}
                        </span>
                    </td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">
                        ${(property.alan || property.area || 0).toLocaleString()} m²
                    </td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">
                        ₺${(property.fiyat || property.price || 0).toLocaleString()}
                    </td>
                    <td class="px-2 py-3 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(property.durum || property.status)}">
                            ${property.durum || property.status || 'Belirtilmemiş'}
                        </span>
                    </td>
                    <td class="px-2 py-3 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${property.published ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${property.published ? 'Yayında' : 'Yayında Değil'}
                        </span>
                    </td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm font-medium">
                        <div class="flex items-center space-x-1">
                            <button onclick="viewProperty('${property.id}')" class="text-primary-blue hover:text-blue-dark p-1">
                                <i class="fas fa-eye text-sm"></i>
                            </button>
                            <button onclick="editProperty('${property.id}')" class="text-primary-green hover:text-green-dark p-1">
                                <i class="fas fa-edit text-sm"></i>
                            </button>
                            <button onclick="deleteProperty('${property.id}')" class="text-red-600 hover:text-red-800 p-1">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Logout function
        function logout() {
            if (confirm('Çıkış yapmak istediğinizden emin misiniz?')) {
                localStorage.removeItem('adminLoggedIn');
                localStorage.removeItem('adminEmail');
                window.location.href = 'admin.html';
            }
        }
    </script>
</body>
</html>
